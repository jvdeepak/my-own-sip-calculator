<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>SIP Calculator (India) â€” Live, Single-File</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* THEME TOKENS */
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
      --btn:#0b1324; --btn-text:#e5e7eb; --table-stripe: rgba(255,255,255,.03);
    }
    [data-theme="light"]{
      --bg:#f8fafc; --panel:#ffffff; --muted:#64748b; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#d97706; --danger:#dc2626; --border:#e2e8f0;
      --btn:#f1f5f9; --btn-text:#0f172a; --table-stripe: rgba(15,23,42,.04);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin: 0; padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      min-height: 100vh;
      overflow: hidden;
    }
    @media (max-width: 1100px) {
      body { height: auto; min-height: 100vh; overflow: visible; }
    }

    header{ padding:12px; text-align:center; position:relative; flex-shrink: 0; }
    main{ flex: 1; min-height: 0; }
    header h1{margin:.1rem 0 .4rem; font-size:1.6rem}
    header p{color:var(--muted); margin:0; font-size:.95rem}

    .topbar{ position:absolute; right:12px; top:12px; display:flex; gap:8px; }
    .iconbtn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:var(--btn); color:var(--btn-text); cursor:pointer; user-select:none;
    }
    .iconbtn:focus{ outline:2px solid var(--accent2); outline-offset:2px }
    .iconbtn svg{ width:18px; height:18px; }

    .container{ 
      width: 100%; height: calc(100vh - 80px); padding: 16px; box-sizing: border-box;
      display: flex; gap: 16px; align-items: stretch;
      overflow: hidden;
      min-height: 600px; /* Ensure minimum height */
    }
    @media (max-width: 1100px){ 
      .container{ 
        flex-direction: column; 
        height: auto; min-height: 100vh;
        overflow: visible;
      } 
    }

    /* Widget System Styles */
    .widget-container {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      padding: 12px;
      border: 2px dashed transparent;
      border-radius: 12px;
      transition: all 0.2s ease;
      flex: 1; /* Take remaining space */
      overflow-y: auto; /* Allow scrolling if needed */
      align-content: start; /* Align widgets to top */
    }
    
    /* Widget styles */
    .input-widget {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: color-mix(in srgb, var(--panel) 95%, transparent);
      backdrop-filter: blur(6px);
      transition: all 0.2s ease;
      position: relative;
      min-height: 80px;
    }
    .input-widget:hover {
      border-color: var(--accent2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    
    .input-widget .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .card{
      background:color-mix(in srgb, var(--panel) 92%, transparent);
      border:1px solid var(--border);
      border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.15);
      backdrop-filter: blur(6px);
      display: flex; flex-direction: column;
      min-height: 0; /* Allow shrinking */
      overflow: hidden; /* Prevent content overflow */
    }
    .card:first-child {
      flex: 1 1 auto; /* Input card - flexible */
      min-width: 400px;
      max-width: 60%; /* Don't dominate the screen */
    }
    .card:last-child {
      flex: 1 1 auto; /* Output card - flexible */
      min-width: 350px;
      overflow: hidden; /* Prevent content overflow */
    }
    @media (max-width: 1100px) {
      .card:first-child, .card:last-child {
        max-width: none;
        min-width: 0;
        flex: none;
      }
    }
    .card h2{margin:.2rem 0 1rem; font-size:1.15rem; color:var(--text)}
    .row{display:grid; gap:12px; grid-template-columns: 1fr 1fr}
    .row-3{display:grid; gap:8px; grid-template-columns: 1fr 1fr 1fr; margin:4px 0;}
    .row-3 .tiny .k{ font-size:.75rem; }
    .row-3 .tiny .v{ font-size:.9rem; font-weight:600; }
    @media (max-width: 680px){ .row, .row-3{ grid-template-columns: 1fr; } }
    label{display:block; font-size:.9rem; color:var(--text); margin-bottom:.35rem}
    input[type="number"], select{
      width:100%; padding:.65rem .7rem; border-radius:12px; border:1px solid var(--border);
      background:var(--btn); color:var(--text); outline:none;
    }
    input[type="number"]:read-only {
      background: color-mix(in srgb, var(--accent) 8%, var(--panel));
      border-color: var(--accent);
      cursor: not-allowed;
      opacity: 0.9;
    }
    input[type="range"]{ width:100% }
    .tiny{font-size:.82rem; color:var(--muted)}
    .help{font-size:.8rem; color:var(--muted); margin-top:.25rem}
    .pill{display:inline-block; padding:.18rem .5rem; border-radius:999px; font-size:.75rem;
      border:1px solid var(--border); background:var(--btn); color:var(--btn-text)}
    .sublabel{ display:flex; justify-content:space-between; gap:8px; align-items:baseline }
    .slider-value{ font-variant-numeric: tabular-nums; color:var(--text); font-size:.9rem }
    .sep{ height:1px; background:var(--border); margin:8px 0 }
    .sep.compact{ margin:4px 0 }
    .right{ text-align:right }

    .out{ display:grid; gap:8px; grid-template-columns: 1fr 1fr; margin:4px 0; }
    @media (max-width:680px){ .out{ grid-template-columns:1fr; } }
    .metric{ padding:10px; border:1px dashed var(--border); border-radius:10px;
      background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, transparent), color-mix(in srgb, var(--accent2) 8%, transparent)); }
    .metric .k{ font-size:.85rem; color:var(--text) }
    .metric .v{ font-weight:700; font-size:1.2rem; margin-top:.2rem; color:var(--text) }
    .metric .tiny{ font-size:.75rem; margin-top:.15rem; }

    /* SETTINGS */
    details.settings{ margin-top:10px }
    details.settings summary{
      list-style:none; cursor:pointer; user-select:none; padding:10px 12px; border-radius:12px;
      background:var(--btn); border:1px solid var(--border); display:flex; align-items:center; gap:10px; color:var(--text);
    }
    details.settings summary .carat{ width:14px; display:inline-block }
    details.settings[open] summary .carat{ transform:rotate(90deg) }
    .settings-body{ margin-top:10px; padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--panel) }
    .grid-2{ display:grid; gap:12px; grid-template-columns:1fr 1fr }
    @media (max-width:680px){ .grid-2{ grid-template-columns:1fr; } }

    /* TABLE (Monthly Breakdown) - Removed duplicate styles */
    /* Table and scroll container styles */
    .tablewrap {
      flex: 1 1 auto; /* Take remaining space in output container and allow growth */
      display: flex;
      flex-direction: column;
      min-height: 0; /* Allow shrinking */
      overflow: hidden; /* Prevent overflow outside the container */
      height: 100%; /* Ensure it takes full height */
      margin-top: 8px; /* Add space between header and table */
    }
    .toolbar {
      flex-shrink: 0; /* Don't shrink toolbar */
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .scroll {
      flex: 1 1 auto; /* Take all remaining space and allow growth */
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--panel);
      min-height: 300px; /* Increased minimum height for scrolling area */
      display: flex; /* Use flexbox to ensure table fills the space */
      flex-direction: column; /* Stack contents vertically */
      height: 100%; /* Ensure it takes full height */
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .table th, .table td {
      padding: 4px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .table th {
      background: color-mix(in srgb, var(--accent) 10%, var(--panel));
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table tbody tr:nth-child(even) {
      background: var(--table-stripe);
    }
    .table tbody tr:hover {
      background: color-mix(in srgb, var(--accent2) 8%, transparent);
    }
    .year-row {
      background: color-mix(in srgb, var(--accent) 8%, var(--panel)) !important;
      transition: background 0.2s ease;
    }
    .year-row td {
      padding: 4px 12px !important;
    }
    .year-row:hover {
      background: color-mix(in srgb, var(--accent) 15%, var(--panel)) !important;
    }
    .expand-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 0.8rem;
      user-select: none;
    }
    .month-row {
      font-size: 0.9em;
      color: var(--muted);
    }
    .month-row td {
      padding: 3px 12px !important;
    }
    .badge{ padding:.16rem .45rem; border-radius:999px; background:var(--btn); border:1px solid var(--border); font-size:.72rem; color:var(--btn-text) }
    .warnbar{ font-size:.82rem; color:color-mix(in srgb, var(--warn) 90%, white); background:color-mix(in srgb, var(--warn) 18%, transparent);
      border:1px solid color-mix(in srgb, var(--warn) 40%, transparent); padding:10px 12px; border-radius:12px }
    
    /* Saved Settings Controls */
    .saved-settings-controls {
      margin-bottom: 16px;
      padding: 12px;
      background: color-mix(in srgb, var(--accent) 5%, var(--panel));
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .settings-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #presetSelector {
      min-width: 150px;
    }
    
    /* Default Values Grid */
    .default-values-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .default-value-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .default-value-item label {
      font-size: 0.9rem;
      font-weight: 500;
    }
  </style>

<style>
/* Resizable output container styling */
#output-container {
    resize: both;
    overflow: hidden; /* Changed from auto to hidden to prevent double scrollbars */
    border: 2px solid var(--border);
    padding: 12px;
    min-width: 350px;
    min-height: 500px;
    max-width: none; /* Remove width constraint */
    max-height: none; /* Remove height constraint */
    width: 100%; height: 100%; /* Fill available space */
    box-sizing: border-box;
    background: color-mix(in srgb, var(--panel) 92%, transparent);
    backdrop-filter: blur(6px);
    display: flex; 
    flex-direction: column;
}

/* Make the resize handle more visible */
#output-container::-webkit-resizer {
    background: repeating-linear-gradient(
        45deg,
        #888,
        #888 2px,
        transparent 2px,
        transparent 4px
    );
}

</style>

</head>
<body>
  <header>
    <div class="topbar">
      <button id="themeBtn" class="iconbtn" title="Toggle dark/light (remembers)">
        <svg id="themeIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path id="moon" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
        </svg>
        <span id="themeLabel">Dark</span>
      </button>
      <button id="gearBtn" class="iconbtn" title="Open Settings (remembers)">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19.14,12.94a7.21,7.21,0,0,0,.05-.94,7.21,7.21,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.73,2H10.27a.5.5,0,0,0-.49.41L9.4,5.06a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L4.86,11.06a7.21,7.21,0,0,0-.05.94,7.21,7.21,0,0,0,.05.94L2.75,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.46a.5.5.5,0,0,0,.49-.41l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
        </svg>
        <span>Settings</span>
      </button>
    </div>

    <h1>Indian SIP Calculator â€” Live</h1>
    <p>Type anywhere. Choose what to <strong>compute</strong>. See results in â‚¹, lakhs & crores.</p>
  </header>

  <main class="container">
    <!-- LEFT: Inputs -->
    <section class="card" aria-labelledby="inputsHdr">
      <h2 id="inputsHdr">Inputs</h2>
      
      <div class="widget-container" id="widget-container">
        <!-- Compute Widget -->
        <div class="input-widget" data-widget="compute">
          <div class="widget-header">
            <span>Compute</span>
          </div>
          <select id="mode">
            <option value="corpus">Target corpus</option>
            <option value="sip" selected>Monthly SIP</option>
            <option value="years">Years</option>
            <option value="rate">Expected return</option>
          </select>
          <div class="help">Pick the unknown. I'll solve for it numerically.</div>
        </div>

        <!-- Monthly SIP Widget -->
        <div class="input-widget" data-widget="sip">
          <div class="widget-header">
            <span>Monthly SIP (â‚¹)</span>
          </div>
          <div class="sublabel">
            <label for="sip" style="margin-bottom: 0;">Amount</label>
            <div class="slider-value" id="sipLive">â‚¹ 25,000</div>
          </div>
          <input id="sip" type="number" min="0" step="100" value="25000" />
          <input id="sipRange" type="range" min="0" max="300000" step="500" value="25000" aria-label="Monthly SIP slider"/>
        </div>

        <!-- Years Widget -->
        <div class="input-widget" data-widget="years">
          <div class="widget-header">
            <span>Years</span>
          </div>
          <input id="years" type="number" min="0" max="80" step="0.25" value="20" inputmode="decimal" />
          <div class="help">You can enter decimals (e.g., 15.5 years).</div>
        </div>

        <!-- Expected Return Widget -->
        <div class="input-widget" data-widget="rate">
          <div class="widget-header">
            <span>Expected Annual Return (%)</span>
          </div>
          <div class="sublabel">
            <label for="rate" style="margin-bottom: 0;">Rate</label>
            <div class="slider-value" id="rateLive">12.00%</div>
          </div>
          <input id="rate" type="number" min="0" max="50" step="0.1" value="12" />
          <input id="rateRange" type="range" min="0" max="50" step="0.1" value="12" aria-label="Rate slider"/>
        </div>

        <!-- Inflation Widget -->
        <div class="input-widget" data-widget="inflation">
          <div class="widget-header">
            <span>Inflation Settings</span>
          </div>
          <label for="inflAdj">Inflation-adjusted return?</label>
          <select id="inflAdj">
            <option value="no">No (use nominal return)</option>
            <option value="yes" selected>Yes (use "real" return)</option>
          </select>
          <div class="help">When "Yes", real return â‰ˆ ((1+R)/(1+Inflation) âˆ’ 1).</div>
          <div id="inflWrap" style="margin-top: 8px;">
            <label for="infl">Inflation (%)</label>
            <input id="infl" type="number" min="3" max="15" step="0.1" value="6" />
            <div class="help">Quickly adjust via <b>Settings â†’ Inflation slider</b> (3%â€“15%).</div>
          </div>
        </div>

        <!-- Step-up Widget -->
        <div class="input-widget" data-widget="stepup">
          <div class="widget-header">
            <span>Step-up Settings</span>
          </div>
          <label for="stepType">Step-up each year</label>
          <select id="stepType" aria-describedby="stepHelp">
            <option value="none">None</option>
            <option value="percent">Percent (%)</option>
            <option value="fixed">Fixed â‚¹</option>
          </select>
          <div id="stepHelp" class="help">Applies at each 12-month boundary.</div>
          <div id="stepValueWrap" style="margin-top: 8px;">
            <label for="stepValue">Step-up value</label>
            <input id="stepValue" type="number" min="0" step="0.1" value="10" />
            <div class="help" id="stepValueHint">If %: 10 â†’ +10% yearly. If â‚¹: adds to monthly SIP each year.</div>
          </div>
        </div>

        <!-- SIP Stop Period Widget -->
        <div class="input-widget" data-widget="sipstop">
          <div class="widget-header">
            <span>SIP Stop Period</span>
          </div>
          <label for="stopSipAfter">
            <input type="checkbox" id="enableStopSip" style="width:auto; margin-right:6px;"/>
            Stop SIP contributions after
          </label>
          <div id="stopSipWrap" style="display:none; margin-top: 8px;">
            <input id="stopSipAfter" type="number" min="0" step="0.25" value="10" inputmode="decimal" />
            <div class="help">Years to contribute. Then corpus grows without new contributions.</div>
          </div>
        </div>

        <!-- Target Corpus Widget -->
        <div class="input-widget" data-widget="target">
          <div class="widget-header">
            <span>Target Corpus</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input id="targetCorpus" type="number" min="0" step="1000" value="0" style="flex: 1;" />
            <select id="corpusUnit" style="width: 80px;">
              <option value="1">â‚¹</option>
              <option value="100000" selected>Lacs</option>
              <option value="10000000">Cr</option>
            </select>
          </div>
          <div class="help">Used when computing Monthly SIP / Years / Rate.</div>
          <div class="tiny" style="margin-top: 8px; text-align: center;">
            <span class="pill">Live</span> Results update as you type or drag sliders.
          </div>
        </div>
      </div>

      <!-- Saved Settings Controls -->
      <div class="saved-settings-controls">
        <div class="settings-row">
          <div class="settings-group">
            <label for="presetSelector">Saved Settings:</label>
            <select id="presetSelector">
              <option value="default">Default</option>
              <!-- Presets will be loaded here -->
            </select>
          </div>
          <div class="settings-group">
            <button id="savePresetBtn" class="iconbtn" title="Save current settings">Save As</button>
            <button id="deletePresetBtn" class="iconbtn" title="Delete selected preset">Delete</button>
          </div>
        </div>
      </div>

      <!-- Collapsible Settings -->
      <details class="settings" id="settingsPanel">
        <summary aria-controls="settingsBody" aria-expanded="false">
          <span class="carat">â–¶</span> Settings
        </summary>
        <div id="settingsBody" class="settings-body">
          <div class="row">
            <div>
              <div class="sublabel">
                <label for="inflRange">Inflation slider (3%â€“15%)</label>
                <div class="slider-value" id="inflLive">6.0%</div>
              </div>
              <input id="inflRange" type="range" min="3" max="15" step="0.1" value="6" aria-label="Inflation slider"/>
              <div class="help">Adjusts the same Inflation field above (kept in sync).</div>
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="tiny">Compounding: <span class="pill">Monthly</span></div>
              <div class="tiny">Step-ups: <span class="pill">At month 13, 25, â€¦</span></div>
              <div class="tiny">Theme: <span class="pill" id="themeStateBadge">Dark</span></div>
              <div class="tiny">Settings open: <span class="pill" id="settingsStateBadge">No</span></div>
            </div>
          </div>
          
          <div class="sep"></div>
          <h3 style="margin: 12px 0 8px 0; font-size: 1rem;">Default Values</h3>
          <div class="help">Set your preferred default values. These will be used when no saved settings exist.</div>
          
          <div class="default-values-grid">
            <div class="default-value-item">
              <label for="defaultSip">Monthly SIP (â‚¹)</label>
              <input id="defaultSip" type="number" min="0" step="100" value="25000" />
            </div>
            
            <div class="default-value-item">
              <label for="defaultYears">Years</label>
              <input id="defaultYears" type="number" min="0" max="80" step="0.25" value="10" />
            </div>
            
            <div class="default-value-item">
              <label for="defaultRate">Expected Annual Return (%)</label>
              <input id="defaultRate" type="number" min="0" max="50" step="0.1" value="12" />
            </div>
            
            <div class="default-value-item">
              <label for="defaultInflation">Inflation (%)</label>
              <input id="defaultInflation" type="number" min="3" max="15" step="0.1" value="6" />
            </div>
            
            <div class="default-value-item">
              <label for="defaultStepType">Step-up Type</label>
              <select id="defaultStepType">
                <option value="none" selected>None</option>
                <option value="percent">Percent (%)</option>
                <option value="fixed">Fixed â‚¹</option>
              </select>
            </div>
            
            <div class="default-value-item">
              <label for="defaultStepValue">Step-up Value</label>
              <input id="defaultStepValue" type="number" min="0" step="0.1" value="10" />
            </div>
            
            <div class="default-value-item">
              <label for="defaultTargetCorpus">Target Corpus</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input id="defaultTargetCorpus" type="number" min="0" step="1000" value="1" style="flex: 1;" />
                <select id="defaultCorpusUnit" style="width: 80px;">
                  <option value="1">â‚¹</option>
                  <option value="100000">Lacs</option>
                  <option value="10000000" selected>Cr</option>
                </select>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 12px;">
            <button id="saveDefaultsBtn" class="iconbtn">Save Default Values</button>
            <button id="resetDefaultsBtn" class="iconbtn">Reset to System Defaults</button>
          </div>
        </div>
      </details>

      <div class="sep"></div>
      <div class="grid-2">
        <div class="tiny">Numerical solver status: <span id="solverStatus" class="badge">Idle</span></div>
        <div class="right tiny">Precision: <span class="badge">Î” â‰¤ 0.01%</span></div>
      </div>
    </section>

    <!-- RIGHT: Outputs -->
    <section class="card" id="output-container" aria-labelledby="outputsHdr">
      <div style="flex-shrink: 0; margin-bottom: 6px;">
        <h2 id="outputsHdr" style="margin: 0 0 2px 0; font-size: 1.1rem;">Outputs</h2>
        <div id="alerts" class="tiny"></div>

        <div class="out" style="margin: 4px 0;">
          <div class="metric" style="padding: 8px;">
            <div class="k">Final corpus</div>
            <div class="v" id="outCorpus">â‚¹ 0</div>
            <div class="tiny muted" id="outCorpusShort">â€”</div>
          </div>
          <div class="metric" style="padding: 8px;">
            <div class="k">Total invested</div>
            <div class="v"><span id="outInvested">â‚¹ 0</span> <span class="tiny muted" id="outInvestedShort"></span></div>
            <div class="tiny muted" style="margin-top: 4px;">Gains: <span id="outGains">â‚¹ 0</span> <span id="outGainsShort"></span></div>
          </div>
        </div>

        <div class="sep compact" style="margin: 2px 0;"></div>
        <div class="row-3" style="margin: 2px 0;">
          <div class="tiny"><div class="k muted">Monthly SIP used</div><div class="v" id="usedSip">â‚¹ 0</div></div>
          <div class="tiny"><div class="k muted">Years used</div><div class="v" id="usedYears">0</div></div>
          <div class="tiny"><div class="k muted">Return (nominal or real)</div><div class="v" id="usedRate">0%</div></div>
        </div>
        <div class="row-3" style="margin: 2px 0;">
          <div class="tiny"><div class="k muted">Inflation adjusted</div><div class="v" id="usedInflAdj">No</div></div>
          <div class="tiny"><div class="k muted">Inflation rate</div><div class="v" id="usedInflRate">0%</div></div>
          <div class="tiny"><div class="k muted">Step-up type</div><div class="v" id="usedStepType">None</div></div>
        </div>
        <div class="row-3" id="sipStopInfoRow" style="margin: 2px 0; display: none;">
          <div class="tiny"><div class="k muted">SIP contributions</div><div class="v" id="usedSipPeriod">â€”</div></div>
          <div class="tiny"><div class="k muted">Growth period</div><div class="v" id="usedGrowthPeriod">â€”</div></div>
          <div class="tiny"></div>
        </div>

        <div class="sep compact" style="margin: 2px 0;"></div>
      </div>

      <!-- Monthly breakdown table + downloads -->
      <div class="tablewrap">
        <div class="toolbar" style="margin-bottom: 4px;">
          <div class="tiny">Monthly breakdown (auto-updates)</div>
          <div class="buttons">
            <button id="btnCsv" class="iconbtn" title="Download CSV">CSV</button>
            <button id="btnXls" class="iconbtn" title="Download Excel (.xls)">Excel</button>
          </div>
        </div>
        <div class="scroll">
          <table class="table" id="scheduleTable">
            <thead>
              <tr>
                <th style="width: 30px;"></th>
                <th>Year</th>
                <th style="text-align:right;">Monthly SIP (â‚¹)</th>
                <th style="text-align:right;">Yearly Investment (â‚¹)</th>
                <th style="text-align:right;">Yearly Interest (â‚¹)</th>
                <th style="text-align:right;">End Balance (â‚¹)</th>
                <th style="text-align:right;">Cumulative Invested (â‚¹)</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
        
        <div class="footnote" style="margin-top: 2px; flex-shrink: 0; font-size: 0.7rem; color: var(--muted);">
          Currency formatting: <code>en-IN</code> (lakhs/crores). Estimates only; not financial advice.
        </div>
      </div>
    </section>
  </main>

  <script>
    /* Theme toggle with persistence */
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');
    const themeStateBadge = document.getElementById('themeStateBadge');
    function getPreferredTheme(){
      const saved = localStorage.getItem('sip_theme');
      if(saved === 'dark' || saved === 'light') return saved;
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      return prefersDark ? 'dark' : 'light';
    }
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('sip_theme', theme);
      themeLabel.textContent = theme === 'dark' ? 'Dark' : 'Light';
      themeStateBadge.textContent = theme === 'dark' ? 'Dark' : 'Light';
      themeIcon.innerHTML = theme === 'dark'
        ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>'
        : '<path d="M6.76 4.84l-1.8-1.79M1 12H3m8-8V1m7.24 3.84l1.8-1.79M23 12h-2M12 23v-2m3.76-1.84l1.8 1.79M4.24 19.16l-1.8 1.79M12 7a5 5 0 100 10 5 5 0 000-10z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
    }
    themeBtn.addEventListener('click', ()=>{
      const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(now);
    });
    applyTheme(getPreferredTheme());

    /* Settings panel persistence + gear btn */
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsStateBadge = document.getElementById('settingsStateBadge');
    const gearBtn = document.getElementById('gearBtn');
    function saveSettingsOpen(open){
      localStorage.setItem('sip_settings_open', open ? '1' : '0');
      settingsStateBadge.textContent = open ? 'Yes' : 'No';
    }
    (function restoreSettingsState(){
      const open = localStorage.getItem('sip_settings_open') === '1';
      settingsPanel.open = open;
      saveSettingsOpen(open);
    })();
    settingsPanel.addEventListener('toggle', ()=>{ saveSettingsOpen(settingsPanel.open); });
    gearBtn.addEventListener('click', ()=>{
      const open = !settingsPanel.open;
      settingsPanel.open = open;
      saveSettingsOpen(open);
      settingsPanel.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>{ const summary = settingsPanel.querySelector('summary'); summary && summary.focus(); }, 120);
    });

    /* Finance math + schedule generation */
    const fmtINR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 });
    const toIndianShort = (n)=>{
      if(!isFinite(n)) return 'â€”';
      const abs=Math.abs(n), sign=n<0?'-':'';
      const lakhs = abs/1e5;
      if(lakhs >= 100) return sign+'â‚¹ '+(abs/1e7).toFixed(2)+' Cr';
      if(abs>=1e5) return sign+'â‚¹ '+lakhs.toFixed(2)+' L';
      return sign+fmtINR.format(abs);
    };
    const clamp=(n,lo,hi)=>Math.min(Math.max(n,lo),hi);
    const isPos=(n)=>isFinite(n)&&n>0;

    function simulate({sip0, years, annRate, stepType, stepVal, stopAfterYears}){
      const monthsTotal = Math.floor(Math.max(0, years) * 12 + 1e-6);
      if(monthsTotal===0) return { corpus:0, invested:0, schedule:[] };
      const mRate = Math.pow(1 + Math.max(-0.9999, annRate), 1/12) - 1;
      const stopAfterMonths = stopAfterYears !== undefined ? Math.floor(stopAfterYears * 12) : monthsTotal;
      let balance=0, invested=0;
      const schedule = [];
      for(let m=0; m<monthsTotal; m++){
        const yearIndex = Math.floor(m/12);
        const monthInYear = (m%12)+1;
        const yearNo = yearIndex + 1;
        let sipM = 0;
        // Only contribute if we haven't reached the stop period
        if(m < stopAfterMonths) {
          sipM = sip0;
          if(stepType==='percent'){
            const g = Math.max(-0.99, (stepVal||0)/100);
            sipM = sip0 * Math.pow(1+g, yearIndex);
          }else if(stepType==='fixed'){
            sipM = sip0 + (stepVal||0)*yearIndex;
          }
          sipM = Math.max(0, sipM);
        }
        // Contribution at start
        balance += sipM;
        invested += sipM;
        // Growth
        const interest = mRate!==0 ? balance * mRate : 0;
        balance += interest;

        schedule.push({
          idx: m+1,
          year: yearNo,
          month: monthInYear,
          sip: sipM,
          mRate: mRate*100,
          interest: interest,
          endBalance: balance,
          cumInvested: invested
        });
      }
      return { corpus:balance, invested, schedule };
    }

    function runModel({ sip0, years, annRateNominal, inflPct, inflAdj, stepType, stepVal, stopAfterYears }){
      const infl = Math.max(0, inflPct)/100;
      const rAnnual = inflAdj ? ((1+annRateNominal)/(1+infl)-1) : annRateNominal;
      return simulate({ sip0, years, annRate:rAnnual, stepType, stepVal, stopAfterYears });
    }

    function solveMonthlyForCorpus(target, params){
      if(!isPos(target)) return {ok:false,value:0,msg:'Invalid target corpus'};
      let lo=0, hi=1_000; const f=s=>runModel({...params,sip0:s}).corpus;
      while(f(hi)<target && hi<1e10) hi*=2;
      if(hi>=1e10 && f(hi)<target) return {ok:false,value:hi,msg:'Target corpus requires monthly SIP beyond â‚¹1000 Cr. Consider increasing years or return rate.'};
      for(let i=0;i<60;i++){ const mid=(lo+hi)/2, v=f(mid); if(Math.abs(v-target)<=Math.max(1,target)*1e-4) return {ok:true,value:mid,msg:'Converged'}; (v<target?lo=mid:hi=mid); }
      return {ok:true,value:(lo+hi)/2,msg:'Max iterations reached'};
    }
    function solveYearsForCorpus(target, params){
      if(!isPos(target)) return {ok:false,value:0,msg:'Invalid target corpus'};
      let lo=0, hi=80; const f=y=>runModel({...params,years:y}).corpus;
      while(f(hi)<target && hi<200) hi*=1.5;
      if(hi>=200 && f(hi)<target) return {ok:false,value:hi,msg:'Target too high for given SIP/rate/step.'};
      for(let i=0;i<60;i++){ const mid=(lo+hi)/2, v=f(mid); if(Math.abs(v-target)<=Math.max(1,target)*1e-4) return {ok:true,value:mid,msg:'Converged'}; (v<target?lo=mid:hi=mid); }
      return {ok:true,value:(lo+hi)/2,msg:'Max iterations reached'};
    }
    function solveRateForCorpus(target, params){
      if(!isPos(target)) return {ok:false,value:0,msg:'Invalid target corpus'};
      let lo=0.0, hi=1.0; const f=r=>runModel({...params,annRateNominal:r}).corpus;
      while(f(hi)<target && hi<2.0) hi*=1.25;
      if(hi>=2.0 && f(hi)<target) return {ok:false,value:hi,msg:'Target too high for rate â‰¤ 200%.'};
      for(let i=0;i<70;i++){ const mid=(lo+hi)/2, v=f(mid); if(Math.abs(v-target)<=Math.max(1,target)*1e-4) return {ok:true,value:mid,msg:'Converged'}; (v<target?lo=mid:hi=mid); }
      return {ok:true,value:(lo+hi)/2,msg:'Max iterations reached'};
    }

    /* DOM */
    const el = id => document.getElementById(id);
    const ui = {
      mode: el('mode'),
      years: el('years'),
      sip: el('sip'), sipRange: el('sipRange'), sipLive: el('sipLive'),
      rate: el('rate'), rateRange: el('rateRange'), rateLive: el('rateLive'),
      inflAdj: el('inflAdj'), infl: el('infl'), inflWrap: el('inflWrap'),
      inflRange: el('inflRange'), inflLive: el('inflLive'),
      stepType: el('stepType'), stepValue: el('stepValue'), stepValueWrap: el('stepValueWrap'), stepValueHint: el('stepValueHint'),
      enableStopSip: el('enableStopSip'), stopSipAfter: el('stopSipAfter'), stopSipWrap: el('stopSipWrap'),
      targetCorpus: el('targetCorpus'), solverStatus: el('solverStatus'), alerts: el('alerts'),
      outCorpus: el('outCorpus'), outCorpusShort: el('outCorpusShort'), outInvested: el('outInvested'), outInvestedShort: el('outInvestedShort'),
      outGains: el('outGains'), outGainsShort: el('outGainsShort'),
      usedSip: el('usedSip'), usedYears: el('usedYears'), usedRate: el('usedRate'),
      usedInflAdj: el('usedInflAdj'), usedInflRate: el('usedInflRate'), usedStepType: el('usedStepType'),
      sipStopInfoRow: el('sipStopInfoRow'), usedSipPeriod: el('usedSipPeriod'), usedGrowthPeriod: el('usedGrowthPeriod'),
      scheduleBody: el('scheduleBody'),
      btnCsv: el('btnCsv'), btnXls: el('btnXls')
    };

    function updateStepUI(){
      const type = ui.stepType.value;
      ui.stepValueWrap.style.display = (type === 'none') ? 'none' : '';
      ui.stepValueHint.textContent = (type === 'percent')
        ? 'If %: 10 â†’ +10% yearly (applied to monthly SIP each year).'
        : 'If â‚¹: this amount is added to the monthly SIP each year.';
    }
    function updateInflUI(){
      ui.inflWrap.style.display = (ui.inflAdj.value === 'yes') ? '' : 'none';
    }
    function updateStopSipUI(){
      ui.stopSipWrap.style.display = ui.enableStopSip.checked ? '' : 'none';
    }
    function updateComputeModeUI(){
      const mode = ui.mode.value;
      // Reset all to editable
      ui.sip.readOnly = false;
      ui.sipRange.disabled = false;
      ui.years.readOnly = false;
      ui.rate.readOnly = false;
      ui.rateRange.disabled = false;
      ui.targetCorpus.readOnly = false;

      // Make the computed field read-only
      if(mode === 'corpus') {
        ui.targetCorpus.readOnly = true;
      } else if(mode === 'sip') {
        ui.sip.readOnly = true;
        ui.sipRange.disabled = true;
      } else if(mode === 'years') {
        ui.years.readOnly = true;
      } else if(mode === 'rate') {
        ui.rate.readOnly = true;
        ui.rateRange.disabled = true;
      }
    }
    function setSolverStatus(msg, tone='idle'){
      ui.solverStatus.textContent = msg;
      const style =
        tone==='ok'  ? 'background:#072810;border-color:#14532d;color:#bbf7d0' :
        tone==='warn'? 'background:#3a2507;border-color:#92400e;color:#fde68a' :
        tone==='err' ? 'background:#3a0f0f;border-color:#7f1d1d;color:#fecaca' :
                       'background:var(--btn);border-color:var(--border);color:var(--btn-text)';
      ui.solverStatus.setAttribute('style', `padding:.16rem .45rem;border-radius:999px;${style}`);
    }
    function showAlert(html){ ui.alerts.innerHTML = '<div class="warnbar">'+html+'</div>'; }
    function clearAlert(){ ui.alerts.innerHTML=''; }
    function syncSliderDisplays(){
      const sipVal = Number(ui.sip.value)||0;
      ui.sipRange.value = clamp(sipVal, Number(ui.sipRange.min), Number(ui.sipRange.max));
      ui.sipLive.textContent = toIndianShort(sipVal);

      const rateVal = clamp(Number(ui.rate.value)||0, 0, 200);
      ui.rateRange.value = clamp(rateVal, Number(ui.rateRange.min), Number(ui.rateRange.max));
      ui.rateLive.textContent = rateVal.toFixed(2) + '%';

      let inflVal = clamp(Number(ui.infl.value)||0, Number(ui.inflRange.min), Number(ui.inflRange.max));
      ui.infl.value = inflVal.toFixed(1);
      ui.inflRange.value = inflVal;
      ui.inflLive.textContent = Number(ui.inflRange.value).toFixed(1) + '%';
    }
    function renderOutputs({corpus, invested, used, inflAdj, inflPct, stepType, stepVal, stopAfterYears}){
      const gains = corpus - invested;
      ui.outCorpus.textContent = fmtINR.format(Math.round(corpus));
      ui.outCorpusShort.textContent = toIndianShort(corpus);
      ui.outInvested.textContent = fmtINR.format(Math.round(invested));
      ui.outInvestedShort.textContent = '(' + toIndianShort(invested) + ')';
      ui.outGains.textContent = fmtINR.format(Math.round(gains));
      ui.outGainsShort.textContent = '(' + toIndianShort(gains) + ')';
      ui.usedSip.textContent = toIndianShort(used.sip0);
      ui.usedYears.textContent = (used.years).toFixed(2);
      ui.usedRate.textContent = (used.ratePct).toFixed(2) + '%';
      ui.usedInflAdj.textContent = inflAdj ? 'Yes' : 'No';
      ui.usedInflRate.textContent = inflPct.toFixed(2) + '%';
      if(stepType === 'none') {
        ui.usedStepType.textContent = 'None';
      } else if(stepType === 'percent') {
        ui.usedStepType.textContent = stepVal.toFixed(1) + '%';
      } else {
        ui.usedStepType.textContent = fmtINR.format(Math.round(stepVal));
      }
      // Show SIP stop period info if enabled
      if(stopAfterYears !== undefined && stopAfterYears < used.years) {
        ui.sipStopInfoRow.style.display = '';
        ui.usedSipPeriod.textContent = stopAfterYears.toFixed(2) + ' yrs';
        ui.usedGrowthPeriod.textContent = (used.years - stopAfterYears).toFixed(2) + ' yrs';
      } else {
        ui.sipStopInfoRow.style.display = 'none';
      }
    }
    function readInputs(){
      const mode = ui.mode.value;
      const sip0 = Math.max(0, Number(ui.sip.value) || 0);
      const years = clamp(Number(ui.years.value) || 0, 0, 200);
      const ratePct = clamp(Number(ui.rate.value) || 0, 0, 200);
      const inflPct = clamp(Number(ui.infl.value) || 0, Number(ui.inflRange.min), Number(ui.inflRange.max));
      const inflAdj = ui.inflAdj.value === 'yes';
      const stepType = ui.stepType.value;
      const stepValue = Math.max(0, Number(ui.stepValue.value) || 0);

      // Get corpus value with unit conversion
      const corpusUnitValue = Number(document.getElementById('corpusUnit').value) || 1;
      const targetCorpus = Math.max(0, (Number(ui.targetCorpus.value) || 0) * corpusUnitValue);

      // Get stop SIP settings
      const enableStopSip = ui.enableStopSip.checked;
      const stopAfterYears = enableStopSip ? clamp(Number(ui.stopSipAfter.value) || years, 0, years) : undefined;

      return { mode, sip0, years, ratePct, annRateNominal: ratePct/100, inflPct, inflAdj,
               stepType, stepVal: stepValue, targetCorpus, stopAfterYears };
    }

    /* Schedule table render */
    function renderSchedule(schedule){
      if(!schedule || schedule.length === 0) {
        ui.scheduleBody.innerHTML = '<tr><td colspan="7" class="tiny">No data</td></tr>';
        return;
      }

      // Group schedule by year
      const yearGroups = {};
      schedule.forEach(r => {
        if(!yearGroups[r.year]) {
          yearGroups[r.year] = [];
        }
        yearGroups[r.year].push(r);
      });

      let html = '';
      Object.keys(yearGroups).forEach(year => {
        const months = yearGroups[year];
        const lastMonth = months[months.length - 1];

        // Calculate yearly totals
        const yearlySip = months[0].sip; // Monthly SIP amount for this year
        const yearlyInvestment = months.reduce((sum, m) => sum + m.sip, 0);
        const yearlyInterest = months.reduce((sum, m) => sum + m.interest, 0);

        // Year summary row (always visible)
        html += '<tr class="year-row" data-year="'+year+'" style="cursor:pointer; font-weight:600;">'
          + '<td style="text-align:center;"><span class="expand-icon">â–¶</span></td>'
          + '<td>Year '+year+'</td>'
          + '<td style="text-align:right">'+fmtINR.format(Math.round(yearlySip))+' <span class="tiny muted">('+toIndianShort(yearlySip)+')</span></td>'
          + '<td style="text-align:right">'+fmtINR.format(Math.round(yearlyInvestment))+' <span class="tiny muted">('+toIndianShort(yearlyInvestment)+')</span></td>'
          + '<td style="text-align:right">'+fmtINR.format(Math.round(yearlyInterest))+' <span class="tiny muted">('+toIndianShort(yearlyInterest)+')</span></td>'
          + '<td style="text-align:right">'+fmtINR.format(Math.round(lastMonth.endBalance))+' <span class="tiny muted">('+toIndianShort(lastMonth.endBalance)+')</span></td>'
          + '<td style="text-align:right">'+fmtINR.format(Math.round(lastMonth.cumInvested))+' <span class="tiny muted">('+toIndianShort(lastMonth.cumInvested)+')</span></td>'
          + '</tr>';

        // Monthly detail rows (hidden by default)
        months.forEach(m => {
          html += '<tr class="month-row" data-year="'+year+'" style="display:none; background: var(--table-stripe);">'
            + '<td></td>'
            + '<td style="padding-left:20px;">Month '+m.month+'</td>'
            + '<td style="text-align:right">'+fmtINR.format(Math.round(m.sip))+' <span class="tiny muted">('+toIndianShort(m.sip)+')</span></td>'
            + '<td style="text-align:right">â€”</td>'
            + '<td style="text-align:right">'+fmtINR.format(Math.round(m.interest))+' <span class="tiny muted">('+toIndianShort(m.interest)+')</span></td>'
            + '<td style="text-align:right">'+fmtINR.format(Math.round(m.endBalance))+' <span class="tiny muted">('+toIndianShort(m.endBalance)+')</span></td>'
            + '<td style="text-align:right">'+fmtINR.format(Math.round(m.cumInvested))+' <span class="tiny muted">('+toIndianShort(m.cumInvested)+')</span></td>'
            + '</tr>';
        });
      });

      ui.scheduleBody.innerHTML = html;

      // Add click handlers for expand/collapse
      document.querySelectorAll('.year-row').forEach(row => {
        row.addEventListener('click', function() {
          const year = this.getAttribute('data-year');
          const monthRows = document.querySelectorAll('.month-row[data-year="'+year+'"]');
          const icon = this.querySelector('.expand-icon');
          const isExpanded = monthRows[0].style.display !== 'none';

          monthRows.forEach(mr => {
            mr.style.display = isExpanded ? 'none' : 'table-row';
          });
          icon.textContent = isExpanded ? 'â–¶' : 'â–¼';
        });
      });
    }

    /* Downloads: CSV and Excel (SpreadsheetML .xls) */
    function download(filename, blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    }
    function toCSV(schedule){
      const header = ['Month#','Year','Month','Monthly SIP (INR)','Monthly Rate (%)','Interest (INR)','End Balance (INR)','Cumulative Invested (INR)'];
      const lines = schedule.map(r => [
        r.idx, r.year, r.month,
        Math.round(r.sip),
        r.mRate.toFixed(6),
        Math.round(r.interest),
        Math.round(r.endBalance),
        Math.round(r.cumInvested)
      ].join(','));
      return header.join(',') + '\n' + lines.join('\n');
    }
    function toXLS(schedule){
      // Minimal Excel 2003 XML Spreadsheet; opens in Excel, Numbers, LibreOffice.
      function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      let xml = '<?xml version="1.0"?>\n'
        + '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"'
        + ' xmlns:o="urn:schemas-microsoft-com:office:office"'
        + ' xmlns:x="urn:schemas-microsoft-com:office:excel"'
        + ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n'
        + '<Worksheet ss:Name="SIP Schedule"><Table>\n';
      const header = ['Month#','Year','Month','Monthly SIP (INR)','Monthly Rate (%)','Interest (INR)','End Balance (INR)','Cumulative Invested (INR)'];
      xml += '<Row>' + header.map(h=>'<Cell><Data ss:Type="String">'+esc(h)+'</Data></Cell>').join('') + '</Row>\n';
      for(const r of schedule){
        xml += '<Row>'
          + `<Cell><Data ss:Type="Number">${r.idx}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${r.year}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${r.month}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${Math.round(r.sip)}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${Number(r.mRate.toFixed(6))}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${Math.round(r.interest)}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${Math.round(r.endBalance)}</Data></Cell>`
          + `<Cell><Data ss:Type="Number">${Math.round(r.cumInvested)}</Data></Cell>`
          + '</Row>\n';
      }
      xml += '</Table></Worksheet></Workbook>';
      return xml;
    }

    function computeAndRender(){
      clearAlert(); updateStepUI(); updateInflUI(); updateStopSipUI(); updateComputeModeUI(); syncSliderDisplays();
      const I = readInputs();

      if(I.mode !== 'corpus' && !isPos(I.targetCorpus)){
        showAlert('To compute <b>'+I.mode.toUpperCase()+'</b>, please provide a positive <b>Target corpus</b>.');
      }

      if(I.mode === 'corpus'){
        setSolverStatus('Idle','idle');
        const { corpus, invested, schedule } = runModel(I);
        // Update target corpus input with computed value
        const corpusUnitValue = Number(document.getElementById('corpusUnit').value) || 1;
        ui.targetCorpus.value = (corpus / corpusUnitValue).toFixed(2);
        renderOutputs({ corpus, invested, used: { sip0:I.sip0, years:I.years, ratePct:I.ratePct }, inflAdj:I.inflAdj, inflPct:I.inflPct, stepType:I.stepType, stepVal:I.stepVal, stopAfterYears:I.stopAfterYears });
        renderSchedule(schedule);
        currentSchedule = schedule;
        return;
      }
      if(I.mode === 'sip'){
        setSolverStatus('Solvingâ€¦','warn');
        const res = solveMonthlyForCorpus(I.targetCorpus, I);
        if(res.ok){
          setSolverStatus(res.msg,'ok');
          const sipSolved = Math.max(0, res.value);
          ui.sip.value = String(Math.round(sipSolved));
          syncSliderDisplays();
          const { corpus, invested, schedule } = runModel({ ...I, sip0:sipSolved });
          renderOutputs({ corpus, invested, used: { sip0:sipSolved, years:I.years, ratePct:I.ratePct }, inflAdj:I.inflAdj, inflPct:I.inflPct, stepType:I.stepType, stepVal:I.stepVal, stopAfterYears:I.stopAfterYears });
          renderSchedule(schedule);
          currentSchedule = schedule;
        }else{ setSolverStatus('Failed','err'); showAlert(res.msg); }
        return;
      }
      if(I.mode === 'years'){
        setSolverStatus('Solvingâ€¦','warn');
        const res = solveYearsForCorpus(I.targetCorpus, I);
        if(res.ok){
          setSolverStatus(res.msg,'ok');
          const ySolved = clamp(res.value, 0, 200);
          ui.years.value = ySolved.toFixed(2);
          const { corpus, invested, schedule } = runModel({ ...I, years:ySolved });
          renderOutputs({ corpus, invested, used: { sip0:I.sip0, years:ySolved, ratePct:I.ratePct }, inflAdj:I.inflAdj, inflPct:I.inflPct, stepType:I.stepType, stepVal:I.stepVal, stopAfterYears:I.stopAfterYears });
          renderSchedule(schedule);
          currentSchedule = schedule;
        }else{ setSolverStatus('Failed','err'); showAlert(res.msg); }
        return;
      }
      if(I.mode === 'rate'){
        setSolverStatus('Solvingâ€¦','warn');
        const res = solveRateForCorpus(I.targetCorpus, I);
        if(res.ok){
          setSolverStatus(res.msg,'ok');
          const rSolvedPct = clamp(res.value*100, 0, 200);
          ui.rate.value = rSolvedPct.toFixed(2);
          syncSliderDisplays();
          const { corpus, invested, schedule } = runModel({ ...I, annRateNominal:rSolvedPct/100 });
          renderOutputs({ corpus, invested, used: { sip0:I.sip0, years:I.years, ratePct:rSolvedPct }, inflAdj:I.inflAdj, inflPct:I.inflPct, stepType:I.stepType, stepVal:I.stepVal, stopAfterYears:I.stopAfterYears });
          renderSchedule(schedule);
          currentSchedule = schedule;
        }else{ setSolverStatus('Failed','err'); showAlert(res.msg); }
        return;
      }
    }

    // Keep a reference for downloads
    let currentSchedule = [];

    // Wire inputs - listen for both 'input' and 'change' events for reliability
    [
      ui.mode, ui.years, ui.sip, ui.rate, ui.inflAdj, ui.infl, ui.stepType, ui.stepValue, ui.targetCorpus, ui.stopSipAfter
    ].forEach(e => {
      e.addEventListener('input', computeAndRender);
      e.addEventListener('change', computeAndRender);
    });

    // Handle stop SIP checkbox
    ui.enableStopSip.addEventListener('change', ()=>{ updateStopSipUI(); computeAndRender(); });

    // Handle corpus unit conversion
    const corpusUnit = document.getElementById('corpusUnit');
    corpusUnit.addEventListener('change', computeAndRender);
    ui.sipRange.addEventListener('input', ()=>{ ui.sip.value = ui.sipRange.value; computeAndRender(); });
    ui.rateRange.addEventListener('input', ()=>{ ui.rate.value = ui.rateRange.value; computeAndRender(); });
    ui.inflRange.addEventListener('input', ()=>{ ui.infl.value = Number(ui.inflRange.value).toFixed(1); computeAndRender(); });
    ui.infl.addEventListener('input', ()=>{
      let v = clamp(Number(ui.infl.value)||0, Number(ui.inflRange.min), Number(ui.inflRange.max));
      ui.infl.value = v.toFixed(1); ui.inflRange.value = v; computeAndRender();
    });

    // Downloads
    ui.btnCsv.addEventListener('click', ()=>{
      const csv = toCSV(currentSchedule);
      download('sip_monthly_breakdown.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
    });
    ui.btnXls.addEventListener('click', ()=>{
      const xls = toXLS(currentSchedule);
      download('sip_monthly_breakdown.xls', new Blob([xls], {type:'application/vnd.ms-excel'}));
    });

  /* Output container resize persistence */
  document.addEventListener('DOMContentLoaded', function() {
    // Load saved output container size from localStorage
    const outputContainer = document.getElementById('output-container');
    if (!outputContainer) return;
    
    const savedWidth = localStorage.getItem('sip_output_width');
    const savedHeight = localStorage.getItem('sip_output_height');
    
    if (savedWidth) outputContainer.style.width = savedWidth;
    if (savedHeight) outputContainer.style.height = savedHeight;
    
    // Save output container size when resized
    const resizeObserver = new ResizeObserver(entries => {
      for (let entry of entries) {
        localStorage.setItem('sip_output_width', entry.target.style.width);
        localStorage.setItem('sip_output_height', entry.target.style.height);
      }
    });
    
    resizeObserver.observe(outputContainer);
    
    // Settings persistence
    setupSettingsPersistence();
    
    // Default values management
    setupDefaultValuesManagement();
    
    // Initial calculation
    calculate();
  });
  
  // Settings persistence and presets functionality
  function setupSettingsPersistence() {
    const presetSelector = document.getElementById('presetSelector');
    const savePresetBtn = document.getElementById('savePresetBtn');
    const deletePresetBtn = document.getElementById('deletePresetBtn');
    
    // Load last used settings
    loadLastUsedSettings();
    
    // Load saved presets into dropdown
    loadSavedPresets();
    
    // Save current settings when inputs change
    function saveCurrentSettings() {
      const settings = getCurrentSettings();
      localStorage.setItem('sip_last_settings', JSON.stringify(settings));
    }
    
    // Add event listeners to all inputs to save settings when changed
    const allInputs = document.querySelectorAll('input, select');
    allInputs.forEach(input => {
      if (input.id !== 'presetSelector') { // Don't trigger on preset selector itself
        input.addEventListener('change', saveCurrentSettings);
      }
    });
    
    // Handle preset selection
    presetSelector.addEventListener('change', function() {
      const selectedPreset = presetSelector.value;
      if (selectedPreset === 'default') {
        resetToDefaultSettings();
      } else {
        loadPreset(selectedPreset);
      }
    });
    
    // Save preset button
    savePresetBtn.addEventListener('click', function() {
      const presetName = prompt('Enter a name for this preset:');
      if (presetName && presetName.trim() !== '') {
        savePreset(presetName.trim());
      }
    });
    
    // Delete preset button
    deletePresetBtn.addEventListener('click', function() {
      const selectedPreset = presetSelector.value;
      if (selectedPreset !== 'default') {
        if (confirm(`Delete preset "${selectedPreset}"?`)) {
          deletePreset(selectedPreset);
        }
      } else {
        alert('Cannot delete the default preset.');
      }
    });
  }
  
  // Get current settings from all inputs
  function getCurrentSettings() {
    return {
      mode: document.getElementById('mode').value,
      years: document.getElementById('years').value,
      sip: document.getElementById('sip').value,
      rate: document.getElementById('rate').value,
      inflAdj: document.getElementById('inflAdj').value,
      infl: document.getElementById('infl').value,
      stepType: document.getElementById('stepType').value,
      stepValue: document.getElementById('stepValue').value,
      targetCorpus: document.getElementById('targetCorpus').value,
      corpusUnit: document.getElementById('corpusUnit').value
    };
  }
  
  // Apply settings to all inputs
  function applySettings(settings) {
    if (!settings) return;
    
    // Apply each setting if it exists
    if (settings.mode) document.getElementById('mode').value = settings.mode;
    if (settings.years) document.getElementById('years').value = settings.years;
    if (settings.sip) {
      document.getElementById('sip').value = settings.sip;
      document.getElementById('sipRange').value = Math.min(settings.sip, document.getElementById('sipRange').max);
    }
    if (settings.rate) {
      document.getElementById('rate').value = settings.rate;
      document.getElementById('rateRange').value = settings.rate;
    }
    if (settings.inflAdj) document.getElementById('inflAdj').value = settings.inflAdj;
    if (settings.infl) {
      document.getElementById('infl').value = settings.infl;
      document.getElementById('inflRange').value = settings.infl;
    }
    if (settings.stepType) document.getElementById('stepType').value = settings.stepType;
    if (settings.stepValue) document.getElementById('stepValue').value = settings.stepValue;
    if (settings.targetCorpus) document.getElementById('targetCorpus').value = settings.targetCorpus;
    if (settings.corpusUnit) document.getElementById('corpusUnit').value = settings.corpusUnit;
    
    // Update UI based on settings
    updateStepUI();
    updateInflUI();
    syncSliderDisplays();
    
    // Recalculate with new settings
    computeAndRender();
  }
  
  // Load last used settings
  function loadLastUsedSettings() {
    try {
      const lastSettings = JSON.parse(localStorage.getItem('sip_last_settings'));
      if (lastSettings) {
        applySettings(lastSettings);
      } else {
        // If no last used settings exist, apply default values
        resetToDefaultSettings();
      }
    } catch (e) {
      console.error('Error loading last settings:', e);
      // If error, apply default values
      resetToDefaultSettings();
    }
  }
  
  // Load all saved presets into dropdown
  function loadSavedPresets() {
    try {
      const presetSelector = document.getElementById('presetSelector');
      const savedPresets = JSON.parse(localStorage.getItem('sip_saved_presets')) || {};
      
      // Clear existing options except default
      while (presetSelector.options.length > 1) {
        presetSelector.remove(1);
      }
      
      // Add saved presets to dropdown
      Object.keys(savedPresets).forEach(presetName => {
        const option = document.createElement('option');
        option.value = presetName;
        option.textContent = presetName;
        presetSelector.appendChild(option);
      });
    } catch (e) {
      console.error('Error loading saved presets:', e);
    }
  }
  
  // Save current settings as a named preset
  function savePreset(presetName) {
    try {
      const settings = getCurrentSettings();
      const savedPresets = JSON.parse(localStorage.getItem('sip_saved_presets')) || {};
      
      savedPresets[presetName] = settings;
      localStorage.setItem('sip_saved_presets', JSON.stringify(savedPresets));
      
      // Reload presets and select the new one
      loadSavedPresets();
      document.getElementById('presetSelector').value = presetName;
      
      alert(`Preset "${presetName}" saved successfully!`);
    } catch (e) {
      console.error('Error saving preset:', e);
      alert('Error saving preset. Please try again.');
    }
  }
  
  // Load a specific preset
  function loadPreset(presetName) {
    try {
      const savedPresets = JSON.parse(localStorage.getItem('sip_saved_presets')) || {};
      if (savedPresets[presetName]) {
        applySettings(savedPresets[presetName]);
      }
    } catch (e) {
      console.error('Error loading preset:', e);
    }
  }
  
  // Delete a preset
  function deletePreset(presetName) {
    try {
      const savedPresets = JSON.parse(localStorage.getItem('sip_saved_presets')) || {};
      if (savedPresets[presetName]) {
        delete savedPresets[presetName];
        localStorage.setItem('sip_saved_presets', JSON.stringify(savedPresets));
        
        // Reload presets and select default
        loadSavedPresets();
        document.getElementById('presetSelector').value = 'default';
        
        alert(`Preset "${presetName}" deleted successfully!`);
      }
    } catch (e) {
      console.error('Error deleting preset:', e);
      alert('Error deleting preset. Please try again.');
    }
  }
  
  // Default values management
  function setupDefaultValuesManagement() {
    const saveDefaultsBtn = document.getElementById('saveDefaultsBtn');
    const resetDefaultsBtn = document.getElementById('resetDefaultsBtn');
    
    // Load saved user defaults into the default values form
    loadUserDefaultsToForm();
    
    // Save defaults button
    saveDefaultsBtn.addEventListener('click', function() {
      saveUserDefaults();
      alert('Default values saved successfully!');
    });
    
    // Reset to system defaults button
    resetDefaultsBtn.addEventListener('click', function() {
      if (confirm('Reset to system defaults? This will remove your custom default values.')) {
        localStorage.removeItem('sip_user_defaults');
        loadSystemDefaultsToForm();
        alert('Reset to system defaults successfully!');
      }
    });
  }
  
  // Get current default values from form
  function getCurrentDefaultValues() {
    return {
      mode: 'sip', // Always default to SIP calculation mode
      years: document.getElementById('defaultYears').value,
      sip: document.getElementById('defaultSip').value,
      rate: document.getElementById('defaultRate').value,
      inflAdj: 'yes', // Always default to inflation-adjusted
      infl: document.getElementById('defaultInflation').value,
      stepType: document.getElementById('defaultStepType').value,
      stepValue: document.getElementById('defaultStepValue').value,
      targetCorpus: document.getElementById('defaultTargetCorpus').value,
      corpusUnit: document.getElementById('defaultCorpusUnit').value
    };
  }
  
  // Save user defaults
  function saveUserDefaults() {
    try {
      const defaultValues = getCurrentDefaultValues();
      localStorage.setItem('sip_user_defaults', JSON.stringify(defaultValues));
    } catch (e) {
      console.error('Error saving user defaults:', e);
      alert('Error saving defaults. Please try again.');
    }
  }
  
  // Load user defaults to form
  function loadUserDefaultsToForm() {
    try {
      const userDefaults = JSON.parse(localStorage.getItem('sip_user_defaults'));
      if (userDefaults) {
        // Apply to default values form
        if (userDefaults.years) document.getElementById('defaultYears').value = userDefaults.years;
        if (userDefaults.sip) document.getElementById('defaultSip').value = userDefaults.sip;
        if (userDefaults.rate) document.getElementById('defaultRate').value = userDefaults.rate;
        if (userDefaults.infl) document.getElementById('defaultInflation').value = userDefaults.infl;
        if (userDefaults.stepType) document.getElementById('defaultStepType').value = userDefaults.stepType;
        if (userDefaults.stepValue) document.getElementById('defaultStepValue').value = userDefaults.stepValue;
        if (userDefaults.targetCorpus) document.getElementById('defaultTargetCorpus').value = userDefaults.targetCorpus;
        if (userDefaults.corpusUnit) document.getElementById('defaultCorpusUnit').value = userDefaults.corpusUnit;
      } else {
        // If no user defaults, load system defaults
        loadSystemDefaultsToForm();
      }
    } catch (e) {
      console.error('Error loading user defaults to form:', e);
      // If error, load system defaults
      loadSystemDefaultsToForm();
    }
  }
  
  // Load system defaults to form
  function loadSystemDefaultsToForm() {
    document.getElementById('defaultYears').value = '10';
    document.getElementById('defaultSip').value = '25000';
    document.getElementById('defaultRate').value = '12';
    document.getElementById('defaultInflation').value = '6';
    document.getElementById('defaultStepType').value = 'none';
    document.getElementById('defaultStepValue').value = '10';
    document.getElementById('defaultTargetCorpus').value = '1';
    document.getElementById('defaultCorpusUnit').value = '10000000'; // 1 Cr
  }
  
  // Reset to default settings
  function resetToDefaultSettings() {
    // Load user-defined defaults if available, otherwise use system defaults
    try {
      const userDefaults = JSON.parse(localStorage.getItem('sip_user_defaults'));
      if (userDefaults) {
        applySettings(userDefaults);
        return;
      }
    } catch (e) {
      console.error('Error loading user defaults:', e);
    }
    
    // System default values
    const systemDefaults = {
      mode: 'sip',
      years: '10',
      sip: '25000',
      rate: '12',
      inflAdj: 'yes',
      infl: '6',
      stepType: 'none',
      stepValue: '10',
      targetCorpus: '1',
      corpusUnit: '10000000' // 1 Cr
    };
    
    applySettings(systemDefaults);
  }
  </script>

</body>
</html>
